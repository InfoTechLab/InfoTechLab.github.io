function removeParameter(e,t){if(-1==e.indexOf("?"))return e;var i=e.split("?")[0],n=e.split("?")[1],s=!1;"#rd"==n.substr(n.length-3)&&(n=n.substr(0,n.length-3),s=!0);for(var a=n.split("&"),l=a.length-1;l>=0;l--){var o=a[l].substr(0,a[l].indexOf("="));o==t&&a.splice(l,1)}var r;return r=0==a.length?i:i+"?"+a.join("&"),s&&(r+="#rd"),r}Auth9G=function(e){this.gameid=e,this.title=document.title,this.uid=null,this.myuid=null,this.accessToken=null,this.user=null,this.order="desc",this.identify=function(){},this.ready=function(){},this.readyDone=!1,this.baseUrl="http://wx.9g.com",this.gameUrl="http://game.9g.com",this.init()},Auth9G.prototype.init=function(){this.uid=this.getParameter("uid"),console.log("uid="+this.uid)},Auth9G.prototype.isWeixin=function(){var e=navigator.userAgent.toLowerCase();return"micromessenger"==e.match(/MicroMessenger/i)?!0:!1},Auth9G.prototype.connect=function(e,t){var i;setTimeout(function(){void 0==i&&(i=!1,t&&t.call(null),console.log("连接超过2秒"))},2e3),jQuery.ajax({type:"GET",async:!0,cache:!1,timeout:5e3,url:this.baseUrl+"/auth/connect",dataType:"jsonp",jsonp:"callback",jsonpCallback:"authConnectHandler",success:function(t){console.log(t),"ok"==t.success&&void 0==i&&(i=!0,e&&e.call(null),console.log("连接测试成功!"))}})},Auth9G.prototype.check=function(){if(document.title="9G游戏",document.body.style.display="none",!this.isWeixin())return console.log("非微信浏览器"),void this.doReady();if(console.log(window.localStorage),!window.localStorage)return console.log("不支持 localStorage"),void this.doReady();if(localStorage.accessToken&&(this.accessToken=localStorage.accessToken,this.doReady()),void 0!=sessionStorage.errcode)return console.log("errcode="+sessionStorage.errcode+", errmsg="+sessionStorage.errmsg),sessionStorage.removeItem("errcode"),sessionStorage.removeItem("errmsg"),void this.doReady();var e=this;this.connect(function(){e.accessToken?e.get9gUser(e.accessToken):e.check9gAuth()},function(){document.title=e.title,document.body.style.display="",setTimeout(function(){try{WeixinJSBridge.call("showOptionMenu")}catch(e){}},2e3)})},Auth9G.prototype.doReady=function(){this.readyDone||(document.title=this.title,document.body.style.display="",this.ready&&this.ready.call(null),this.readyDone=!0,console.log("ready"),setTimeout(function(){try{WeixinJSBridge.call("showOptionMenu")}catch(e){}},2e3))},Auth9G.prototype.check9gAuth=function(){var e=removeParameter(window.location.href,"uid"),t=this.gameUrl+"/auth/trans.html?gameid="+this.gameid+"&origin="+encodeURIComponent(e),i=this.baseUrl+"/auth/check?fromurl="+encodeURIComponent(t);null!=this.uid&&(i+="&uid="+this.uid),window.location=i},Auth9G.prototype.get9gUser=function(e){var t=this;jQuery.ajax({type:"GET",async:!0,cache:!1,url:this.baseUrl+"/auth/get9guser?access_token="+e,dataType:"jsonp",jsonp:"callback",jsonpCallback:"get9gUserHandler",success:function(e){e.errcode?(localStorage.removeItem("accessToken"),t.accessToken=null,t.check9gAuth()):(t.myuid=e.uid,t.user=e.user,t.identify&&t.identify.call(null),console.log(e))},error:function(e,t,i){alert(t+"\n"+i)}})},Auth9G.prototype.gotoRank=function(e){var t=this.baseUrl+"/rank/rank.jsp?gameid="+this.gameid+"&order="+this.order+"&type="+e;window.location=t},Auth9G.prototype.submit=function(e,t,i){this.user&&jQuery.ajax({type:"GET",async:!0,cache:!1,url:this.baseUrl+"/rank/submit.jsp?gameid="+this.gameid+"&access_token="+this.accessToken+"&score="+e+"&scorename="+encodeURIComponent(t)+"&order="+this.order,dataType:"jsonp",jsonp:"callback",jsonpCallback:"submitCompleteHandler",success:function(e){alert("ok"==e.submit?e.refreshRankScore?"你的成绩已经成功提交到9G！\n刷新了上一次的最好成绩: "+e.lastRankScoreName:"你的成绩已经成功提交到9G！":"提交成绩失败"),i&&i.apply(null)},error:function(e,t,i){alert(t+"\n"+i)}})},Auth9G.prototype.getParameter=function(e){var t=new RegExp("(^|&)"+e+"=([^&]*)(&|$)","i"),i=window.location.search.substr(1).match(t);return null!=i?i[2]:null};